pipeline {
    agent any

    parameters {
        string(name: "ACCOUNT_ID", defaultValue: "440764891644", description: "Enter AWS Account ID")
        string(name: "AWS_REGION", defaultValue: "us-east-1", description: "Enter AWS Region")
        choice(name: "Infra", choices: ['plan','apply','destroy'], description: 'Select what you want Terraform to do')
    }

    environment {
        TF_DIR= "${WORKSPACE}/terraform"
    }

    stages {
        stage("Install terraform") {
            steps {
                script {
                    def terraform_installed = sh(script: "command -v terraform >/dev/null 2>&1", returnStatus: true)

                    if (terraform_installed == 0) {
                        echo "Terraform is already installed. Skipping installation."
                    } else {
                        echo "Terraform not found. Installing..."
                        sh '''
                            wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
                            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
                            sudo apt update && sudo apt install -y terraform
                            terraform --version
                        '''
                    }
                }
            }
        }

        stage('Terraform Plan') {
            when { expression { params.Infra == 'plan' } }
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                    echo "Running terraform plan..."
                    sh """
                        cd ${TF_DIR}
                        terraform init -input=false
                        terraform plan
                    """
                }
            }
        }

        stage('Terraform Apply') {
            when { expression { params.Infra == 'apply' } }
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                    echo "Running terraform apply..."
                    sh """
                        cd ${TF_DIR}
                        terraform apply -auto-approve
                    """
                }
            }
        }

        stage('Terraform Destroy') {
            when { expression { params.Infra == 'destroy' } }
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                    echo "Running terraform destroy..."
                    sh """  
                        cd ${TF_DIR}
                        terraform destroy -auto-approve
                    """
                }
            }
        }
    }
}

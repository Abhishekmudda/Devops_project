pipeline {
    agent any

    parameters {
        string(name: "ACCOUNT_ID", defaultValue: "440764891644", description: "Enter AWS Account ID")
        string(name: "AWS_REGION", defaultValue: "us-east-1", description: "Enter AWS Region")
        string(name: "ECR_REPO", defaultValue: "student-management", description: "Enter ECR Repository Name")
    }

    environment {
        PLAYBOOK_FILE = "deploy_to_ecr.yml"
        ANSIBLE_IMAGE = "cytopia/ansible:latest"
        PROJECT_DIR   = "${WORKSPACE}/ansible-project"
    }
    stages {
        stage ("Install ansible") {
            steps { 
                script { 
                    def ansibleInstalled = sh(script: "command -v ansible >/dev/null 2>&1", returnStatus: true)

                    if (ansibleInstalled == 0) {
                        echo "Ansible already installed. Skipping Installation"
                    } else {
                        echo "Anisble is not found. Installing....."
                        sh '''
                        sudo add-apt-repository ppa:ansible/ansible
                        sudo apt update
                        echo "Installing ansible"
                        sudo apt install ansible -y
                        echo "Ansible version"
                        ansible --version 
                        '''
                    }
                }
            }
        }

        stage('Install Docker') {
            steps {
                script {
                    def dockerInstalled = sh(script: "command -v docker >/dev/null 2>&1", returnStatus: true)

                    if (dockerInstalled == 0) {
                        echo "Docker already installed. Skipping Installation"
                    } else {
                        sh '''
                            echo "Updating system..."
                            sudo apt update -y

                            echo "Installing Docker..."
                            sudo apt install -y docker.io

                            echo "Adding Jenkins to docker group..."
                            sudo usermod -aG docker jenkins

                            sudo systemctl enable docker
                            sudo systemctl start docker

                            echo "Docker installed successfully."
                        '''
                    }
                }
            }
        }

        stage('Pull Ansible Repository') {
            steps {
                sh '''
                    echo "Cloning Ansible repository..."
                    rm -rf ${PROJECT_DIR}
                    git clone https://github.com/Abhishekmudda/Devops_project.git ${PROJECT_DIR}
                    echo "Repository cloned at: ${PROJECT_DIR}"
                '''
            }
        }

        stage('Deploy to ECR via Ansible') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                sh '''
                    echo "AWS KEY = $AWS_ACCESS_KEY_ID"
                    echo "AWS SECRET = $AWS_SECRET_ACCESS_KEY"
                    echo "AWS REGION = ${AWS_REGION}"
                    cd ${PROJECT_DIR}/Ansible
                    pwd
                    echo "Executing Ansible playbook"
                    ansible-playbook ${PLAYBOOK_FILE} --extra-vars "aws_region=${AWS_REGION} ecr_repo=${ECR_REPO} account_id=${ACCOUNT_ID}"
                    echo "ECR deployment completed successfully."
                '''
                }
            }
        }
    }
}
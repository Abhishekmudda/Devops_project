---
- name: Configure OIDC and install AWS Load Balancer Controller on EKS
  hosts: all
  become: yes
  become_user: ubuntu
  gather_facts: false

  vars_files:
    - vars.yaml 
  
  vars:
    ansible_become_flags: "-H -S"
    
  tasks:
    - name: Update kubeconfig for the EKS cluster
      command: >
        aws eks update-kubeconfig
        --region {{ aws_region }}
        --name {{ cluster_name }}
      register: update_kubeconfig
      changed_when: "'Added new context' in update_kubeconfig.stdout"

    - name: Get EKS cluster OIDC issuer URL
      command: >
        aws eks describe-cluster
        --name {{ cluster_name }}
        --region {{ aws_region }}
        --query cluster.identity.oidc.issuer
        --output text
      register: oidc_issuer
      changed_when: false

    - name: Extract OIDC ID from issuer URL
      set_fact:
        oidc_id: "{{ oidc_issuer.stdout.split('/') | last }}"

    - name: List existing IAM OIDC providers
      command: aws iam list-open-id-connect-providers
      register: oidc_providers
      changed_when: false

    - name: Associate IAM OIDC provider with the cluster if missing
      command: >
        eksctl utils associate-iam-oidc-provider
        --region={{ aws_region }}
        --cluster={{ cluster_name }}
        --approve
      when: oidc_id not in oidc_providers.stdout

    # - name: Download IAM policy JSON for AWS Load Balancer Controller
    #   get_url:
    #     url: "https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/{{ alb_controller_version }}/docs/install/iam_policy.json"
    #     dest: "{{ iam_policy_file }}"
    #     mode: '0644'
    
    - name: Copy IAM policy file to remote server
      copy:
        src: iam-policy.json
        dest: /tmp/iam-policy.json


    - name: Check if IAM policy for AWS Load Balancer Controller already exists
      command: >
        aws iam list-policies
        --scope Local
        --query "Policies[?PolicyName=='{{ iam_policy_name }}'].Arn"
        --output text
      register: lb_policy
      changed_when: false

    - name: Create IAM policy for AWS Load Balancer Controller (if not exists)
      command: >
        aws iam create-policy
        --policy-name AWSLoadBalancerControllerIAMPolicy
        --policy-document file:///tmp/iam-policy.json
        --query 'Policy.Arn'
        --output text
      when: lb_policy.stdout == ""
      register: created_policy

    - name: Set IAM policy ARN fact
      set_fact:
        lb_policy_arn: "{{ created_policy.stdout | default(lb_policy.stdout) }}"

    - name: Create IAM service account for AWS Load Balancer Controller
      command: >
        eksctl create iamserviceaccount
        --cluster student-cluster
        --region us-east-1
        --namespace kube-system 
        --name aws-load-balancer-controller
        --role-name AmazonEKSLoadBalancerControllerRole
        --attach-policy-arn arn:aws:iam::440764891644:policy/AWSLoadBalancerControllerIAMPolicy
        --approve
        --override-existing-serviceaccounts
      register: iam_sa
      changed_when: "'created' in iam_sa.stdout or 'updated' in iam_sa.stdout"

    - debug:
        var: iam_sa.stdout

    - name: Download Helm installation script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0755'

    - name: Install Helm
      command: /tmp/get_helm.sh

    - name: Add EKS Helm repository (eks)
      command: helm repo add eks https://aws.github.io/eks-charts
      register: helm_repo_add
      failed_when: helm_repo_add.rc != 0 and
                   ("exists" not in helm_repo_add.stderr | default("")) and
                   ("already" not in helm_repo_add.stderr | default(""))

    - name: Update Helm repositories
      command: helm repo update

    - name: Install/Upgrade AWS Load Balancer Controller via Helm
      command: >
        helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller
        --namespace kube-system
        --set clusterName={{ cluster_name }}
        --set serviceAccount.create=false
        --set serviceAccount.name=aws-load-balancer-controller
        --set region={{ aws_region }}
        --set vpcId={{ vpc_id }}
      register: helm_lb
      changed_when: helm_lb.rc == 0

    - name: Wait for ALB controller deployment to be ready
      command: kubectl rollout status deployment/aws-load-balancer-controller -n kube-system --timeout=300s
      register: rollout_status
      changed_when: false

    - name: Get ALB controller pods
      command: >
        kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
      register: alb_pods
      changed_when: false

    - debug:
        var: alb_pods.stdout
    
    - name: Describe ALB pods
      command: kubectl describe pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
      register: alb_pods_describe
      changed_when: false

    - debug:
        var: alb_pods_describe.stdout
